<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>コードメモ帳 - Code Notepad (MEL対応)</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/codemirror@5.65.2/lib/codemirror.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/codemirror@5.65.2/theme/monokai.css">
    <script src="https://cdn.jsdelivr.net/npm/codemirror@5.65.2/lib/codemirror.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/codemirror@5.65.2/mode/javascript/javascript.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/codemirror@5.65.2/mode/python/python.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/codemirror@5.65.2/mode/xml/xml.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/codemirror@5.65.2/mode/css/css.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/codemirror@5.65.2/mode/clike/clike.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/codemirror@5.65.2/addon/edit/closebrackets.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/codemirror@5.65.2/addon/edit/matchbrackets.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/codemirror@5.65.2/addon/selection/active-line.js"></script>
    <style>
        .CodeMirror {
            height: 100%;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 14px;
        }
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen">
    <div class="container mx-auto px-4 py-6">
        <!-- Header -->
        <div class="mb-6">
            <h1 class="text-3xl font-bold text-center mb-2">
                <i class="fas fa-code mr-2"></i>
                コードメモ帳
            </h1>
            <p class="text-gray-400 text-center">Maya MEL対応オンラインコードエディタ</p>
        </div>

        <!-- Controls -->
        <div class="bg-gray-800 rounded-lg p-4 mb-4">
            <div class="flex flex-wrap items-center gap-4 mb-4">
                <!-- Language Selection -->
                <div class="flex items-center space-x-2">
                    <label class="text-sm font-medium">言語:</label>
                    <select id="languageSelect" class="bg-gray-700 border border-gray-600 rounded px-3 py-1 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="mel">Maya MEL</option>
                        <option value="python">Python</option>
                        <option value="javascript">JavaScript</option>
                        <option value="html">HTML</option>
                        <option value="css">CSS</option>
                        <option value="java">Java</option>
                        <option value="cpp">C++</option>
                        <option value="text">Text</option>
                    </select>
                </div>

                <!-- File Name Input -->
                <div class="flex items-center space-x-2">
                    <label class="text-sm font-medium">ファイル名:</label>
                    <input type="text" id="fileNameInput" placeholder="untitled" 
                           class="bg-gray-700 border border-gray-600 rounded px-3 py-1 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 w-32">
                </div>

                <!-- Action Buttons -->
                <div class="flex items-center space-x-2">
                    <button id="saveBtn" class="bg-blue-600 hover:bg-blue-700 px-3 py-1 rounded text-sm transition-colors">
                        <i class="fas fa-save mr-1"></i>保存
                    </button>
                    <button id="loadBtn" class="bg-green-600 hover:bg-green-700 px-3 py-1 rounded text-sm transition-colors">
                        <i class="fas fa-folder-open mr-1"></i>読み込み
                    </button>
                    <button id="exportBtn" class="bg-purple-600 hover:bg-purple-700 px-3 py-1 rounded text-sm transition-colors">
                        <i class="fas fa-download mr-1"></i>エクスポート
                    </button>
                    <button id="clearBtn" class="bg-red-600 hover:bg-red-700 px-3 py-1 rounded text-sm transition-colors">
                        <i class="fas fa-trash mr-1"></i>クリア
                    </button>
                </div>
            </div>

            <!-- Saved Files -->
            <div class="flex items-center space-x-2">
                <label class="text-sm font-medium">保存済み:</label>
                <select id="savedFilesSelect" class="bg-gray-700 border border-gray-600 rounded px-3 py-1 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 flex-1">
                    <option value="">ファイルを選択...</option>
                </select>
                <button id="deleteFileBtn" class="bg-red-600 hover:bg-red-700 px-2 py-1 rounded text-sm transition-colors">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>

        <!-- Code Editor -->
        <div class="bg-gray-800 rounded-lg overflow-hidden" style="height: 600px;">
            <textarea id="codeEditor" placeholder="ここにコードを入力してください..."></textarea>
        </div>

        <!-- Footer -->
        <div class="mt-4 text-center text-gray-400 text-sm">
            <p>自動保存機能付き | Maya MEL言語対応 | 複数言語構文ハイライト</p>
        </div>
    </div>

    <script>
        // MEL Language Mode Definition
        CodeMirror.defineMode("mel", function(config, parserConfig) {
            const keywords = "if else for while do switch case default break continue return function proc global source catch";
            const builtins = "print clear select move rotate scale setAttr getAttr listAttr connectAttr disconnectAttr delete duplicate group ungroup parent unparent xform ls file playbackOptions currentTime";
            const types = "int float string vector matrix";
            
            const keywordsRegex = new RegExp("\\b(" + keywords.split(" ").join("|") + ")\\b");
            const builtinsRegex = new RegExp("\\b(" + builtins.split(" ").join("|") + ")\\b");
            const typesRegex = new RegExp("\\b(" + types.split(" ").join("|") + ")\\b");

            return {
                token: function(stream, state) {
                    if (stream.match(/\/\/.*$/)) {
                        return "comment";
                    }
                    if (stream.match(/\/\*[\s\S]*?\*\//)) {
                        return "comment";
                    }
                    if (stream.match(/"([^"\\]|\\.)*"/)) {
                        return "string";
                    }
                    if (stream.match(/'([^'\\]|\\.)*'/)) {
                        return "string";
                    }
                    if (stream.match(/\b\d+\.?\d*\b/)) {
                        return "number";
                    }
                    if (stream.match(keywordsRegex)) {
                        return "keyword";
                    }
                    if (stream.match(builtinsRegex)) {
                        return "builtin";
                    }
                    if (stream.match(typesRegex)) {
                        return "type";
                    }
                    if (stream.match(/[$][a-zA-Z_][a-zA-Z0-9_]*/)) {
                        return "variable";
                    }
                    stream.next();
                    return null;
                }
            };
        });

        // Initialize CodeMirror
        const editor = CodeMirror.fromTextArea(document.getElementById('codeEditor'), {
            theme: 'monokai',
            lineNumbers: true,
            mode: 'mel',
            autoCloseBrackets: true,
            matchBrackets: true,
            styleActiveLine: true,
            indentUnit: 4,
            indentWithTabs: false,
            lineWrapping: true
        });

        // Language modes mapping
        const languageModes = {
            'mel': 'mel',
            'python': 'python',
            'javascript': 'javascript',
            'html': 'xml',
            'css': 'css',
            'java': 'text/x-java',
            'cpp': 'text/x-c++src',
            'text': 'text/plain'
        };

        // Elements
        const languageSelect = document.getElementById('languageSelect');
        const fileNameInput = document.getElementById('fileNameInput');
        const saveBtn = document.getElementById('saveBtn');
        const loadBtn = document.getElementById('loadBtn');
        const exportBtn = document.getElementById('exportBtn');
        const clearBtn = document.getElementById('clearBtn');
        const savedFilesSelect = document.getElementById('savedFilesSelect');
        const deleteFileBtn = document.getElementById('deleteFileBtn');

        // Auto-save functionality
        let autoSaveTimeout;
        editor.on('change', () => {
            clearTimeout(autoSaveTimeout);
            autoSaveTimeout = setTimeout(() => {
                const code = editor.getValue();
                localStorage.setItem('codeNotepad_autoSave', code);
                localStorage.setItem('codeNotepad_autoSave_lang', languageSelect.value);
            }, 1000);
        });

        // Load auto-saved content
        function loadAutoSave() {
            const savedCode = localStorage.getItem('codeNotepad_autoSave');
            const savedLang = localStorage.getItem('codeNotepad_autoSave_lang');
            if (savedCode) {
                editor.setValue(savedCode);
            }
            if (savedLang) {
                languageSelect.value = savedLang;
                changeLanguage();
            }
        }

        // Change language mode
        function changeLanguage() {
            const selectedLang = languageSelect.value;
            const mode = languageModes[selectedLang];
            editor.setOption('mode', mode);
        }

        // Save file
        function saveFile() {
            const fileName = fileNameInput.value.trim() || 'untitled';
            const code = editor.getValue();
            const language = languageSelect.value;
            
            const fileData = {
                code: code,
                language: language,
                timestamp: new Date().toISOString()
            };
            
            localStorage.setItem(`codeNotepad_file_${fileName}`, JSON.stringify(fileData));
            updateSavedFilesList();
            
            // Show success message
            showMessage('ファイルが保存されました: ' + fileName, 'success');
        }

        // Load file
        function loadFile(fileName) {
            if (!fileName) return;
            
            const fileData = localStorage.getItem(`codeNotepad_file_${fileName}`);
            if (fileData) {
                const parsed = JSON.parse(fileData);
                editor.setValue(parsed.code);
                languageSelect.value = parsed.language;
                fileNameInput.value = fileName;
                changeLanguage();
                showMessage('ファイルが読み込まれました: ' + fileName, 'success');
            }
        }

        // Export file
        function exportFile() {
            const fileName = fileNameInput.value.trim() || 'untitled';
            const language = languageSelect.value;
            const extension = getFileExtension(language);
            const code = editor.getValue();
            
            const blob = new Blob([code], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${fileName}.${extension}`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showMessage('ファイルがエクスポートされました', 'success');
        }

        // Get file extension based on language
        function getFileExtension(language) {
            const extensions = {
                'mel': 'mel',
                'python': 'py',
                'javascript': 'js',
                'html': 'html',
                'css': 'css',
                'java': 'java',
                'cpp': 'cpp',
                'text': 'txt'
            };
            return extensions[language] || 'txt';
        }

        // Clear editor
        function clearEditor() {
            if (confirm('エディタの内容をクリアしますか？')) {
                editor.setValue('');
                fileNameInput.value = '';
                showMessage('エディタがクリアされました', 'info');
            }
        }

        // Update saved files list
        function updateSavedFilesList() {
            savedFilesSelect.innerHTML = '<option value="">ファイルを選択...</option>';
            
            const keys = Object.keys(localStorage).filter(key => key.startsWith('codeNotepad_file_'));
            keys.forEach(key => {
                const fileName = key.replace('codeNotepad_file_', '');
                const option = document.createElement('option');
                option.value = fileName;
                option.textContent = fileName;
                savedFilesSelect.appendChild(option);
            });
        }

        // Delete file
        function deleteFile() {
            const fileName = savedFilesSelect.value;
            if (!fileName) return;
            
            if (confirm(`ファイル "${fileName}" を削除しますか？`)) {
                localStorage.removeItem(`codeNotepad_file_${fileName}`);
                updateSavedFilesList();
                showMessage('ファイルが削除されました: ' + fileName, 'info');
            }
        }

        // Show message
        function showMessage(message, type = 'info') {
            const colors = {
                'success': 'bg-green-600',
                'error': 'bg-red-600',
                'info': 'bg-blue-600'
            };
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `fixed top-4 right-4 ${colors[type]} text-white px-4 py-2 rounded shadow-lg z-50 transition-opacity duration-300`;
            messageDiv.textContent = message;
            
            document.body.appendChild(messageDiv);
            
            setTimeout(() => {
                messageDiv.style.opacity = '0';
                setTimeout(() => {
                    document.body.removeChild(messageDiv);
                }, 300);
            }, 3000);
        }

        // Event listeners
        languageSelect.addEventListener('change', changeLanguage);
        saveBtn.addEventListener('click', saveFile);
        loadBtn.addEventListener('click', () => {
            const fileName = savedFilesSelect.value;
            if (fileName) {
                loadFile(fileName);
            } else {
                showMessage('ファイルを選択してください', 'error');
            }
        });
        exportBtn.addEventListener('click', exportFile);
        clearBtn.addEventListener('click', clearEditor);
        savedFilesSelect.addEventListener('change', (e) => {
            if (e.target.value) {
                loadFile(e.target.value);
            }
        });
        deleteFileBtn.addEventListener('click', deleteFile);

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey || e.metaKey) {
                switch (e.key) {
                    case 's':
                        e.preventDefault();
                        saveFile();
                        break;
                    case 'o':
                        e.preventDefault();
                        const fileName = savedFilesSelect.value;
                        if (fileName) loadFile(fileName);
                        break;
                    case 'e':
                        e.preventDefault();
                        exportFile();
                        break;
                }
            }
        });

        // Initialize
        loadAutoSave();
        updateSavedFilesList();
        
        // Set focus to editor
        setTimeout(() => {
            editor.focus();
        }, 100);
    </script>
</body>
</html>
