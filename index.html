<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>共有コードメモ帳 - Shared Code Notepad (MEL対応)</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <style>
        .code-editor {
            font-family: 'Courier New', monospace;
            background: #1a1a1a;
            color: #f8f8f2;
            border: none;
            outline: none;
            resize: vertical;
            line-height: 1.5;
            padding: 15px;
            border-radius: 8px;
        }
        
        .syntax-mel { color: #ff6b6b; }
        .syntax-keyword { color: #66d9ef; }
        .syntax-string { color: #a6e22e; }
        .syntax-comment { color: #75715e; }
        .syntax-number { color: #ae81ff; }
        .syntax-function { color: #fd971f; }
        
        .file-card {
            transition: all 0.3s ease;
            border-left: 4px solid transparent;
        }
        
        .file-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            border-left-color: #3b82f6;
        }
        
        .favorite-btn {
            transition: color 0.2s ease;
        }
        
        .favorite-btn.active {
            color: #fbbf24;
        }
        
        .language-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 500;
        }
        
        .mel { background-color: #ef4444; color: white; }
        .python { background-color: #3776ab; color: white; }
        .javascript { background-color: #f7df1e; color: black; }
        .html { background-color: #e34f26; color: white; }
        .css { background-color: #1572b6; color: white; }
        .java { background-color: #007396; color: white; }
        .cpp { background-color: #00599c; color: white; }
        .text { background-color: #6b7280; color: white; }

        .tab-button {
            transition: all 0.3s ease;
        }
        
        .tab-button.active {
            background-color: #3b82f6;
            color: white;
        }
        
        .shared-files-panel {
            max-height: calc(100vh - 200px);
            overflow-y: auto;
        }
        
        .code-preview {
            font-family: 'Courier New', monospace;
            font-size: 0.8rem;
            line-height: 1.4;
            max-height: 100px;
            overflow: hidden;
            background: #f8f9fa;
            padding: 8px;
            border-radius: 4px;
            border-left: 3px solid #3b82f6;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <div class="container mx-auto px-4 py-6 max-w-7xl">
        <!-- Header -->
        <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
            <div class="flex items-center justify-between flex-wrap gap-4">
                <div>
                    <h1 class="text-3xl font-bold text-gray-800 mb-2">
                        <i class="fas fa-code text-blue-600 mr-3"></i>
                        共有コードメモ帳
                    </h1>
                    <p class="text-gray-600">MEL対応 - 全ユーザーでファイル共有可能</p>
                </div>
                <div class="flex items-center space-x-4">
                    <div class="text-sm text-gray-500">
                        <i class="fas fa-users mr-1"></i>
                        オンラインユーザー: <span class="font-semibold text-green-600" id="onlineUsers">3</span>
                    </div>
                    <div class="text-sm text-gray-500">
                        <i class="fas fa-file-code mr-1"></i>
                        共有ファイル: <span class="font-semibold text-blue-600" id="totalFiles">12</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Code Editor Panel -->
            <div class="lg:col-span-2">
                <div class="bg-white rounded-lg shadow-sm p-6">
                    <!-- Editor Controls -->
                    <div class="flex flex-wrap items-center justify-between mb-6 gap-4">
                        <div class="flex items-center space-x-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">言語選択</label>
                                <select id="languageSelect" class="border border-gray-300 rounded-lg px-3 py-2 bg-white focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    <option value="mel">MEL</option>
                                    <option value="python">Python</option>
                                    <option value="javascript">JavaScript</option>
                                    <option value="html">HTML</option>
                                    <option value="css">CSS</option>
                                    <option value="java">Java</option>
                                    <option value="cpp">C++</option>
                                    <option value="text">Plain Text</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">ファイル名</label>
                                <input type="text" id="fileName" placeholder="untitled" class="border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                        </div>
                        <div class="flex items-center space-x-2">
                            <button id="saveBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors">
                                <i class="fas fa-save mr-2"></i>保存
                            </button>
                            <button id="shareBtn" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg transition-colors">
                                <i class="fas fa-share-alt mr-2"></i>共有
                            </button>
                            <button id="exportBtn" class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-lg transition-colors">
                                <i class="fas fa-download mr-2"></i>エクスポート
                            </button>
                        </div>
                    </div>

                    <!-- Code Editor -->
                    <div class="mb-4">
                        <textarea id="codeEditor" class="code-editor w-full h-96 resize-y" placeholder="ここにコードを入力してください..."></textarea>
                    </div>

                    <!-- Editor Status -->
                    <div class="flex items-center justify-between text-sm text-gray-500 border-t pt-4">
                        <div class="flex items-center space-x-4">
                            <span><i class="fas fa-file-alt mr-1"></i>行数: <span id="lineCount">1</span></span>
                            <span><i class="fas fa-font mr-1"></i>文字数: <span id="charCount">0</span></span>
                            <span id="lastSaved" class="hidden"><i class="fas fa-clock mr-1"></i>最終保存: <span></span></span>
                        </div>
                        <div class="flex items-center space-x-2">
                            <span class="text-green-600"><i class="fas fa-circle text-xs mr-1"></i>自動保存 ON</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Shared Files Panel -->
            <div class="lg:col-span-1">
                <div class="bg-white rounded-lg shadow-sm">
                    <!-- Tabs -->
                    <div class="flex border-b">
                        <button id="sharedTab" class="tab-button active flex-1 py-3 px-4 text-center font-medium">
                            <i class="fas fa-globe mr-2"></i>共有ファイル
                        </button>
                        <button id="myFilesTab" class="tab-button flex-1 py-3 px-4 text-center font-medium">
                            <i class="fas fa-folder mr-2"></i>マイファイル
                        </button>
                    </div>

                    <!-- Search and Filter -->
                    <div class="p-4 border-b">
                        <div class="mb-3">
                            <input type="text" id="searchInput" placeholder="ファイル名で検索..." class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div class="flex items-center space-x-2">
                            <select id="languageFilter" class="flex-1 border border-gray-300 rounded-lg px-2 py-1 text-sm">
                                <option value="">全言語</option>
                                <option value="mel">MEL</option>
                                <option value="python">Python</option>
                                <option value="javascript">JavaScript</option>
                                <option value="html">HTML</option>
                                <option value="css">CSS</option>
                                <option value="java">Java</option>
                                <option value="cpp">C++</option>
                            </select>
                            <button id="favoritesOnly" class="border border-gray-300 rounded-lg px-2 py-1 text-sm hover:bg-gray-50">
                                <i class="fas fa-star text-yellow-500"></i>
                            </button>
                        </div>
                    </div>

                    <!-- File Lists -->
                    <div id="sharedFilesPanel" class="shared-files-panel p-4">
                        <div id="sharedFilesList"></div>
                    </div>
                    
                    <div id="myFilesPanel" class="shared-files-panel p-4 hidden">
                        <div id="myFilesList"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for File Details -->
    <div id="fileModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-lg max-w-4xl w-full mx-4 max-h-90vh overflow-hidden">
            <div class="flex items-center justify-between p-6 border-b">
                <h3 class="text-lg font-semibold" id="modalTitle">ファイル詳細</h3>
                <button id="closeModal" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div class="p-6 overflow-y-auto" style="max-height: 70vh;">
                <div id="modalContent"></div>
            </div>
            <div class="flex items-center justify-end space-x-3 p-6 border-t">
                <button id="loadFileBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg">
                    <i class="fas fa-upload mr-2"></i>エディタに読み込み
                </button>
                <button id="favoriteModalBtn" class="bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-2 rounded-lg">
                    <i class="fas fa-star mr-2"></i>お気に入り
                </button>
                <button id="closeModalBtn" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg">閉じる</button>
            </div>
        </div>
    </div>

    <script>
        // Global Variables
        let currentUser = 'ユーザー' + Math.floor(Math.random() * 1000);
        let favorites = JSON.parse(localStorage.getItem('favorites') || '[]');
        let myFiles = JSON.parse(localStorage.getItem('myFiles') || '[]');
        let currentModalFile = null;

        // Sample shared files data
        let sharedFiles = [
            {
                id: 'shared_1',
                name: 'maya_cube_creator.mel',
                language: 'mel',
                author: 'Maya太郎',
                created: '2024-01-15T10:30:00Z',
                modified: '2024-01-15T14:20:00Z',
                size: 1024,
                favorites: 15,
                code: `// Maya Cube Creator Script
string $cubeName = "MyCube";
polyCube -name $cubeName -width 2 -height 2 -depth 2;
select $cubeName;
move 0 1 0;
rotate 45 0 0;
setAttr ($cubeName + ".translateY") 2;`
            },
            {
                id: 'shared_2', 
                name: 'batch_render.mel',
                language: 'mel',
                author: 'CG Artist',
                created: '2024-01-14T09:15:00Z',
                modified: '2024-01-16T11:45:00Z',
                size: 2048,
                favorites: 8,
                code: `// Batch Render Script
string $cameras[] = {"camera1", "camera2", "camera3"};
for ($cam in $cameras) {
    lookThroughModelPanel $cam "modelPanel4";
    render -camera $cam;
    print ("Rendered from: " + $cam + "\\n");
}`
            },
            {
                id: 'shared_3',
                name: 'object_manager.py',
                language: 'python',
                author: 'Python Developer',
                created: '2024-01-13T16:00:00Z',
                modified: '2024-01-17T09:30:00Z',
                size: 3072,
                favorites: 23,
                code: `import maya.cmds as cmds

class ObjectManager:
    def __init__(self):
        self.objects = []
    
    def create_sphere(self, name="sphere"):
        sphere = cmds.polySphere(name=name)
        self.objects.append(sphere[0])
        return sphere[0]
    
    def create_cube(self, name="cube"):
        cube = cmds.polyCube(name=name)
        self.objects.append(cube[0])
        return cube[0]
    
    def delete_all(self):
        for obj in self.objects:
            if cmds.objExists(obj):
                cmds.delete(obj)
        self.objects = []`
            },
            {
                id: 'shared_4',
                name: 'animation_helper.mel',
                language: 'mel',
                author: 'Animator',
                created: '2024-01-12T14:20:00Z',
                modified: '2024-01-18T08:15:00Z',
                size: 1536,
                favorites: 12,
                code: `// Animation Helper Functions
proc setKeyframes(string $object, float $startTime, float $endTime) {
    currentTime $startTime;
    setKeyframe $object;
    currentTime $endTime;
    setKeyframe $object;
}

proc createAnimationCycle(string $object, int $frames) {
    for ($i = 0; $i < $frames; $i++) {
        currentTime $i;
        rotate 0 ($i * 10) 0 $object;
        setKeyframe $object;
    }
}`
            },
            {
                id: 'shared_5',
                name: 'utils.js',
                language: 'javascript',
                author: 'WebDev',
                created: '2024-01-11T12:10:00Z',
                modified: '2024-01-19T15:40:00Z',
                size: 896,
                favorites: 6,
                code: `// Utility Functions
function formatDate(date) {
    return new Intl.DateTimeFormat('ja-JP').format(new Date(date));
}

function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}`
            }
        ];

        // Initialize application
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
            updateStats();
            renderSharedFiles();
            renderMyFiles();
            setupEventListeners();
            loadAutoSave();
        });

        function initializeApp() {
            // Simulate online users count
            setInterval(() => {
                const onlineCount = Math.floor(Math.random() * 5) + 2;
                document.getElementById('onlineUsers').textContent = onlineCount;
            }, 30000);
        }

        function updateStats() {
            document.getElementById('totalFiles').textContent = sharedFiles.length;
        }

        function setupEventListeners() {
            const codeEditor = document.getElementById('codeEditor');
            const languageSelect = document.getElementById('languageSelect');
            const saveBtn = document.getElementById('saveBtn');
            const shareBtn = document.getElementById('shareBtn');
            const exportBtn = document.getElementById('exportBtn');
            const searchInput = document.getElementById('searchInput');
            const languageFilter = document.getElementById('languageFilter');
            const favoritesOnly = document.getElementById('favoritesOnly');
            const sharedTab = document.getElementById('sharedTab');
            const myFilesTab = document.getElementById('myFilesTab');

            // Code editor events
            codeEditor.addEventListener('input', function() {
                updateStats();
                applySyntaxHighlighting();
                autoSave();
            });

            // Language selection
            languageSelect.addEventListener('change', function() {
                applySyntaxHighlighting();
            });

            // Button events
            saveBtn.addEventListener('click', saveFile);
            shareBtn.addEventListener('click', shareFile);
            exportBtn.addEventListener('click', exportFile);

            // Search and filter
            searchInput.addEventListener('input', debounce(filterFiles, 300));
            languageFilter.addEventListener('change', filterFiles);
            favoritesOnly.addEventListener('click', toggleFavoritesFilter);

            // Tab switching
            sharedTab.addEventListener('click', () => switchTab('shared'));
            myFilesTab.addEventListener('click', () => switchTab('my'));

            // Modal events
            document.getElementById('closeModal').addEventListener('click', closeModal);
            document.getElementById('closeModalBtn').addEventListener('click', closeModal);
            document.getElementById('loadFileBtn').addEventListener('click', loadFileToEditor);
            document.getElementById('favoriteModalBtn').addEventListener('click', toggleModalFavorite);

            // Click outside modal to close
            document.getElementById('fileModal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeModal();
                }
            });
        }

        function updateStats() {
            const code = document.getElementById('codeEditor').value;
            const lines = code.split('\n').length;
            const chars = code.length;
            
            document.getElementById('lineCount').textContent = lines;
            document.getElementById('charCount').textContent = chars;
        }

        function applySyntaxHighlighting() {
            // Simple syntax highlighting simulation
            const editor = document.getElementById('codeEditor');
            const language = document.getElementById('languageSelect').value;
            
            // Add language-specific class for styling
            editor.className = `code-editor w-full h-96 resize-y lang-${language}`;
        }

        function saveFile() {
            const fileName = document.getElementById('fileName').value || 'untitled';
            const language = document.getElementById('languageSelect').value;
            const code = document.getElementById('codeEditor').value;
            
            if (!code.trim()) {
                alert('コードが入力されていません。');
                return;
            }

            const file = {
                id: 'my_' + Date.now(),
                name: fileName + '.' + getFileExtension(language),
                language: language,
                author: currentUser,
                created: new Date().toISOString(),
                modified: new Date().toISOString(),
                size: code.length,
                code: code
            };

            myFiles.unshift(file);
            localStorage.setItem('myFiles', JSON.stringify(myFiles));
            
            document.getElementById('lastSaved').classList.remove('hidden');
            document.getElementById('lastSaved').querySelector('span').textContent = formatTime(new Date());
            
            renderMyFiles();
            showNotification('ファイルを保存しました: ' + file.name, 'success');
        }

        function shareFile() {
            const fileName = document.getElementById('fileName').value || 'untitled';
            const language = document.getElementById('languageSelect').value;
            const code = document.getElementById('codeEditor').value;
            
            if (!code.trim()) {
                alert('コードが入力されていません。');
                return;
            }

            const file = {
                id: 'shared_' + Date.now(),
                name: fileName + '.' + getFileExtension(language),
                language: language,
                author: currentUser,
                created: new Date().toISOString(),
                modified: new Date().toISOString(),
                size: code.length,
                favorites: 0,
                code: code
            };

            sharedFiles.unshift(file);
            updateStats();
            renderSharedFiles();
            showNotification('ファイルを共有しました: ' + file.name, 'success');
        }

        function exportFile() {
            const fileName = document.getElementById('fileName').value || 'untitled';
            const language = document.getElementById('languageSelect').value;
            const code = document.getElementById('codeEditor').value;
            
            if (!code.trim()) {
                alert('エクスポートするコードがありません。');
                return;
            }

            const blob = new Blob([code], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = fileName + '.' + getFileExtension(language);
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showNotification('ファイルをエクスポートしました', 'success');
        }

        function autoSave() {
            const code = document.getElementById('codeEditor').value;
            const fileName = document.getElementById('fileName').value || 'untitled';
            const language = document.getElementById('languageSelect').value;
            
            localStorage.setItem('autoSave', JSON.stringify({
                code: code,
                fileName: fileName,
                language: language,
                timestamp: Date.now()
            }));
        }

        function loadAutoSave() {
            const autoSave = JSON.parse(localStorage.getItem('autoSave') || 'null');
            if (autoSave && (Date.now() - autoSave.timestamp) < 24 * 60 * 60 * 1000) {
                document.getElementById('codeEditor').value = autoSave.code;
                document.getElementById('fileName').value = autoSave.fileName;
                document.getElementById('languageSelect').value = autoSave.language;
                updateStats();
                applySyntaxHighlighting();
            }
        }

        function renderSharedFiles() {
            const container = document.getElementById('sharedFilesList');
            const filteredFiles = getFilteredFiles(sharedFiles);
            
            if (filteredFiles.length === 0) {
                container.innerHTML = '<div class="text-center text-gray-500 py-8">該当するファイルがありません</div>';
                return;
            }

            container.innerHTML = filteredFiles.map(file => `
                <div class="file-card bg-gray-50 rounded-lg p-4 mb-3 cursor-pointer" onclick="showFileDetails('${file.id}', 'shared')">
                    <div class="flex items-start justify-between mb-2">
                        <div class="flex-1 min-w-0">
                            <h4 class="font-medium text-gray-800 truncate">${file.name}</h4>
                            <p class="text-sm text-gray-600">by ${file.author}</p>
                        </div>
                        <div class="flex items-center space-x-2">
                            <span class="language-badge ${file.language}">${file.language.toUpperCase()}</span>
                            <button class="favorite-btn ${favorites.includes(file.id) ? 'active' : ''}" onclick="event.stopPropagation(); toggleFavorite('${file.id}')">
                                <i class="fas fa-star"></i>
                            </button>
                        </div>
                    </div>
                    <div class="code-preview">${escapeHtml(file.code.substring(0, 100))}${file.code.length > 100 ? '...' : ''}</div>
                    <div class="flex items-center justify-between mt-3 text-xs text-gray-500">
                        <span><i class="fas fa-clock mr-1"></i>${formatTime(file.modified)}</span>
                        <div class="flex items-center space-x-3">
                            <span><i class="fas fa-heart mr-1"></i>${file.favorites}</span>
                            <span><i class="fas fa-file-alt mr-1"></i>${file.size}B</span>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function renderMyFiles() {
            const container = document.getElementById('myFilesList');
            
            if (myFiles.length === 0) {
                container.innerHTML = '<div class="text-center text-gray-500 py-8">保存されたファイルがありません</div>';
                return;
            }

            container.innerHTML = myFiles.map(file => `
                <div class="file-card bg-blue-50 rounded-lg p-4 mb-3 cursor-pointer" onclick="showFileDetails('${file.id}', 'my')">
                    <div class="flex items-start justify-between mb-2">
                        <div class="flex-1 min-w-0">
                            <h4 class="font-medium text-gray-800 truncate">${file.name}</h4>
                            <p class="text-sm text-gray-600">by ${file.author}</p>
                        </div>
                        <div class="flex items-center space-x-2">
                            <span class="language-badge ${file.language}">${file.language.toUpperCase()}</span>
                            <button class="text-red-500 hover:text-red-700" onclick="event.stopPropagation(); deleteMyFile('${file.id}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                    <div class="code-preview">${escapeHtml(file.code.substring(0, 100))}${file.code.length > 100 ? '...' : ''}</div>
                    <div class="flex items-center justify-between mt-3 text-xs text-gray-500">
                        <span><i class="fas fa-clock mr-1"></i>${formatTime(file.modified)}</span>
                        <span><i class="fas fa-file-alt mr-1"></i>${file.size}B</span>
                    </div>
                </div>
            `).join('');
        }

        function getFilteredFiles(files) {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const languageFilter = document.getElementById('languageFilter').value;
            const showFavoritesOnly = document.getElementById('favoritesOnly').classList.contains('active');

            return files.filter(file => {
                const matchesSearch = file.name.toLowerCase().includes(searchTerm) || 
                                    file.author.toLowerCase().includes(searchTerm);
                const matchesLanguage = !languageFilter || file.language === languageFilter;
                const matchesFavorites = !showFavoritesOnly || favorites.includes(file.id);

                return matchesSearch && matchesLanguage && matchesFavorites;
            });
        }

        function filterFiles() {
            renderSharedFiles();
        }

        function toggleFavoritesFilter() {
            const btn = document.getElementById('favoritesOnly');
            btn.classList.toggle('active');
            btn.classList.toggle('bg-yellow-100');
            filterFiles();
        }

        function switchTab(tab) {
            const sharedTab = document.getElementById('sharedTab');
            const myFilesTab = document.getElementById('myFilesTab');
            const sharedPanel = document.getElementById('sharedFilesPanel');
            const myFilesPanel = document.getElementById('myFilesPanel');

            if (tab === 'shared') {
                sharedTab.classList.add('active');
                myFilesTab.classList.remove('active');
                sharedPanel.classList.remove('hidden');
                myFilesPanel.classList.add('hidden');
            } else {
                myFilesTab.classList.add('active');
                sharedTab.classList.remove('active');
                myFilesPanel.classList.remove('hidden');
                sharedPanel.classList.add('hidden');
            }
        }

        function showFileDetails(fileId, type) {
            const files = type === 'shared' ? sharedFiles : myFiles;
            const file = files.find(f => f.id === fileId);
            
            if (!file) return;

            currentModalFile = { file, type };
            
            document.getElementById('modalTitle').textContent = file.name;
            document.getElementById('modalContent').innerHTML = `
                <div class="space-y-4">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">ファイル名</label>
                            <p class="text-gray-900">${file.name}</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">言語</label>
                            <span class="language-badge ${file.language}">${file.language.toUpperCase()}</span>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">作成者</label>
                            <p class="text-gray-900">${file.author}</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">サイズ</label>
                            <p class="text-gray-900">${file.size} bytes</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">作成日時</label>
                            <p class="text-gray-900">${formatDateTime(file.created)}</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">更新日時</label>
                            <p class="text-gray-900">${formatDateTime(file.modified)}</p>
                        </div>
                    </div>
                    ${file.favorites !== undefined ? `
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">お気に入り数</label>
                        <p class="text-gray-900"><i class="fas fa-heart text-red-500 mr-1"></i>${file.favorites}</p>
                    </div>
                    ` : ''}
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">コード内容</label>
                        <pre class="bg-gray-900 text-green-400 p-4 rounded-lg overflow-x-auto text-sm"><code>${escapeHtml(file.code)}</code></pre>
                    </div>
                </div>
            `;

            const favoriteBtn = document.getElementById('favoriteModalBtn');
            if (favorites.includes(file.id)) {
                favoriteBtn.innerHTML = '<i class="fas fa-heart mr-2"></i>お気に入り解除';
                favoriteBtn.className = 'bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg';
            } else {
                favoriteBtn.innerHTML = '<i class="fas fa-star mr-2"></i>お気に入り';
                favoriteBtn.className = 'bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-2 rounded-lg';
            }

            document.getElementById('fileModal').classList.remove('hidden');
            document.getElementById('fileModal').classList.add('flex');
        }

        function closeModal() {
            document.getElementById('fileModal').classList.add('hidden');
            document.getElementById('fileModal').classList.remove('flex');
            currentModalFile = null;
        }

        function loadFileToEditor() {
            if (!currentModalFile) return;
            
            const file = currentModalFile.file;
            document.getElementById('codeEditor').value = file.code;
            document.getElementById('fileName').value = file.name.replace(/\.[^/.]+$/, "");
            document.getElementById('languageSelect').value = file.language;
            
            updateStats();
            applySyntaxHighlighting();
            closeModal();
            showNotification('ファイルをエディタに読み込みました', 'success');
        }

        function toggleModalFavorite() {
            if (!currentModalFile) return;
            
            toggleFavorite(currentModalFile.file.id);
            showFileDetails(currentModalFile.file.id, currentModalFile.type);
        }

        function toggleFavorite(fileId) {
            const index = favorites.indexOf(fileId);
            if (index > -1) {
                favorites.splice(index, 1);
                showNotification('お気に入りから削除しました', 'info');
            } else {
                favorites.push(fileId);
                showNotification('お気に入りに追加しました', 'success');
            }
            
            localStorage.setItem('favorites', JSON.stringify(favorites));
            renderSharedFiles();
        }

        function deleteMyFile(fileId) {
            if (confirm('このファイルを削除しますか？')) {
                myFiles = myFiles.filter(f => f.id !== fileId);
                localStorage.setItem('myFiles', JSON.stringify(myFiles));
                renderMyFiles();
                showNotification('ファイルを削除しました', 'info');
            }
        }

        function getFileExtension(language) {
            const extensions = {
                'mel': 'mel',
                'python': 'py',
                'javascript': 'js',
                'html': 'html',
                'css': 'css',
                'java': 'java',
                'cpp': 'cpp',
                'text': 'txt'
            };
            return extensions[language] || 'txt';
        }

        function formatTime(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const diff = now - date;
            const minutes = Math.floor(diff / 60000);
            const hours = Math.floor(diff / 3600000);
            const days = Math.floor(diff / 86400000);

            if (minutes < 1) return 'たった今';
            if (minutes < 60) return `${minutes}分前`;
            if (hours < 24) return `${hours}時間前`;
            if (days < 7) return `${days}日前`;
            return date.toLocaleDateString('ja-JP');
        }

        function formatDateTime(dateString) {
            return new Date(dateString).toLocaleString('ja-JP');
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 px-6 py-3 rounded-lg text-white z-50 transition-all duration-300 ${
                type === 'success' ? 'bg-green-500' : 
                type === 'error' ? 'bg-red-500' : 
                type === 'info' ? 'bg-blue-500' : 'bg-gray-500'
            }`;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transform = 'translateX(100%)';
                setTimeout(() => {
                    document.body.removeChild(notification);
                }, 300);
            }, 3000);
        }
    </script>
</body>
</html>
